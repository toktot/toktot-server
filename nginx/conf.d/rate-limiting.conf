# 일반 API 요청 제한
location /api/ {
    limit_req zone=api burst=20 nodelay;
    limit_req_status 429;

    # 정상 프록시 처리
    proxy_pass http://app:8080;
    include /etc/nginx/conf.d/proxy_params.conf;
}

# 로그인 관련 API 제한 강화
location ~ ^/api/(auth|login|signin) {
    limit_req zone=login burst=5 nodelay;
    limit_req_status 429;

    proxy_pass http://app:8080;
    include /etc/nginx/conf.d/proxy_params.conf;
}

# 회원가입 관련 API 제한
location ~ ^/api/(register|signup|join) {
    limit_req zone=login burst=3 nodelay;
    limit_req_status 429;

    proxy_pass http://app:8080;
    include /etc/nginx/conf.d/proxy_params.conf;
}

# 비밀번호 재설정 API 제한
location ~ ^/api/(password|reset|forgot) {
    limit_req zone=login burst=3 nodelay;
    limit_req_status 429;

    proxy_pass http://app:8080;
    include /etc/nginx/conf.d/proxy_params.conf;
}

# 파일 업로드 API 제한
location ~ ^/api/(upload|file) {
    limit_req zone=upload burst=10 nodelay;
    limit_req_status 429;

    # 파일 업로드를 위한 더 큰 클라이언트 바디 사이즈
    client_max_body_size 20M;

    proxy_pass http://app:8080;
    include /etc/nginx/conf.d/proxy_params.conf;

    # 업로드를 위한 더 긴 타임아웃
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
}

# 검색 API 제한 (검색은 상대적으로 자주 사용)
location ~ ^/api/(search|find) {
    limit_req zone=search burst=30 nodelay;
    limit_req_status 429;

    proxy_pass http://app:8080;
    include /etc/nginx/conf.d/proxy_params.conf;
}

# 리뷰 작성 API 제한
location ~ ^/api/reviews {
    limit_req zone=review burst=10 nodelay;
    limit_req_status 429;

    proxy_pass http://app:8080;
    include /etc/nginx/conf.d/proxy_params.conf;
}

# 이메일 인증 API 제한
location ~ ^/api/(email|verification|verify) {
    limit_req zone=email burst=5 nodelay;
    limit_req_status 429;

    proxy_pass http://app:8080;
    include /etc/nginx/conf.d/proxy_params.conf;
}

# 관리자 API 제한 (매우 엄격)
location ~ ^/api/admin {
    limit_req zone=admin burst=5 nodelay;
    limit_req_status 429;

    proxy_pass http://app:8080;
    include /etc/nginx/conf.d/proxy_params.conf;
}

# Rate Limit 에러 페이지 커스터마이징
error_page 429 @rate_limit_error;

location @rate_limit_error {
    internal;
    add_header Content-Type application/json always;
    add_header Access-Control-Allow-Origin $allowed_origin always;
    add_header Access-Control-Allow-Credentials true always;

    return 429 '{"error": "Too Many Requests", "message": "요청이 너무 많습니다. 잠시 후 다시 시도해주세요.", "code": "RATE_LIMIT_EXCEEDED", "retryAfter": 60}';
}