name: Deploy To Dev Server

on:
  push:
    branches:
      - dev

concurrency:
  group: deploy-dev
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Discord ë°°í¬ ì‹œì‘ ì•Œë¦¼
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "âš ï¸ TokTot Dev ì„œë²„ ë°°í¬ ì‹œì‘"
          description: |
            **ğŸ”§ ë°°í¬ ì§„í–‰ ì¤‘ - ì¼ì‹œì  ì„œë¹„ìŠ¤ ì¤‘ë‹¨**
            
            **ì»¤ë°‹**: ${{ github.event.head_commit.message }}
            
            ğŸ“Š **ì§„í–‰ìƒí™©**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 0xffa500
          username: "TokTot Deploy Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Docker Hub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/toktot:dev
            ${{ secrets.DOCKERHUB_USERNAME }}/toktot:dev-${{ github.sha }}

      - name: EC2 ë°°í¬ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          COMMIT_SHA: ${{ github.sha }}
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          TOUR_API_SERVICE_KEY: ${{ secrets.TOUR_API_SERVICE_KEY }}
          FIREBASE_SERVICE_ACCOUNT_KEY_BASE64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY_BASE64 }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          envs: DOCKERHUB_USERNAME,COMMIT_SHA,DISCORD_WEBHOOK_URL,GITHUB_REPOSITORY,GITHUB_RUN_ID,POSTGRES_PASSWORD,JWT_SECRET,KAKAO_CLIENT_ID,KAKAO_CLIENT_SECRET,MAIL_USERNAME,MAIL_PASSWORD,REDIS_PASSWORD,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,S3_BUCKET_NAME,KAKAO_REST_API_KEY,TOUR_API_SERVICE_KEY
          script: |
            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
            cd toktot-server
            
            # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
            chmod +x scripts/*.sh
            
            # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ (í™˜ê²½ë³€ìˆ˜ëŠ” ìë™ìœ¼ë¡œ ì „ë‹¬ë¨)
            ./scripts/deploy.sh

      - name: Discord ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "âœ… TokTot Dev ì„œë²„ ë°°í¬ ì„±ê³µ"
          description: |
            **ğŸ‰ ë°°í¬ ì™„ë£Œ - ì„œë¹„ìŠ¤ ì •ìƒ ìš´ì˜ ì¤‘**
            
            **ì»¤ë°‹**: ${{ github.event.head_commit.message }}
            **ìƒˆ ë²„ì „**: `dev-${{ github.sha }}`
            **ë°°í¬ ì‹œê°„**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          color: 0x00ff00
          username: "TokTot Deploy Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

      - name: Discord ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "ğŸ”„ TokTot Dev ì„œë²„ ë°°í¬ ì‹¤íŒ¨"
          description: |
            **âš ï¸ ë°°í¬ ì‹¤íŒ¨ ê°ì§€**
            
            **ğŸ” ì‹¤íŒ¨í•œ ë°°í¬**:
            - **ë¸Œëœì¹˜**: ${{ github.ref_name }}
            - **ì»¤ë°‹**: ${{ github.event.head_commit.message }}
            - **ì‘ì„±ì**: ${{ github.event.head_commit.author.name }}
          color: 0xff9900
          username: "TokTot Deploy Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"