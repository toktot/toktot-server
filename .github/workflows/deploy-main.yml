name: Deploy To Server

on:
  push:
    branches:
      - main

concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Discord Î∞∞Ìè¨ ÏãúÏûë ÏïåÎ¶º
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "‚ö†Ô∏è TokTot ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÏãúÏûë"
          description: |
            **üîß Î∞∞Ìè¨ ÏßÑÌñâ Ï§ë - ÏùºÏãúÏ†Å ÏÑúÎπÑÏä§ Ï§ëÎã®**
            
            **Ïª§Î∞ã**: ${{ github.event.head_commit.message }}
            
            üìä **ÏßÑÌñâÏÉÅÌô©**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 0xffa500
          username: "TokTot Deploy Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Build with Gradle
        run: ./gradlew clean build -x test

      - name: Docker Hub Î°úÍ∑∏Ïù∏
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú Î∞è Ìë∏Ïãú
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/toktot:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/toktot:main
            ${{ secrets.DOCKERHUB_USERNAME }}/toktot:main-${{ github.sha }}

      - name: EC2 Î∞∞Ìè¨ Ïã§Ìñâ
        uses: appleboy/ssh-action@v1.0.3
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          COMMIT_SHA: ${{ github.sha }}
          DEPLOY_BRANCH: main
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          TOUR_API_SERVICE_KEY: ${{ secrets.TOUR_API_SERVICE_KEY }}
          FIREBASE_SERVICE_ACCOUNT_KEY_BASE64: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY_BASE64 }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          envs: DOCKERHUB_USERNAME,COMMIT_SHA,DEPLOY_BRANCH,DISCORD_WEBHOOK_URL,GITHUB_REPOSITORY,GITHUB_RUN_ID,POSTGRES_PASSWORD,JWT_SECRET,KAKAO_CLIENT_ID,KAKAO_CLIENT_SECRET,MAIL_USERNAME,MAIL_PASSWORD,REDIS_PASSWORD,AWS_ACCESS_KEY_ID,AWS_SECRET_ACCESS_KEY,S3_BUCKET_NAME,KAKAO_REST_API_KEY,TOUR_API_SERVICE_KEY,FIREBASE_SERVICE_ACCOUNT_KEY_BASE64,FIREBASE_PROJECT_ID
          script: |
            cd toktot-server
            chmod +x scripts/*.sh
            ./scripts/deploy.sh
      - name: Discord Î∞∞Ìè¨ ÏÑ±Í≥µ ÏïåÎ¶º
        if: success()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "‚úÖ TokTot ÏÑúÎ≤Ñ Î∞∞Ìè¨ ÏÑ±Í≥µ"
          description: |
            **üéâ Î∞∞Ìè¨ ÏôÑÎ£å - ÏÑúÎπÑÏä§ Ï†ïÏÉÅ Ïö¥ÏòÅ Ï§ë**
            
            **Ïª§Î∞ã**: ${{ github.event.head_commit.message }}
            **ÏÉà Î≤ÑÏ†Ñ**: `main-${{ github.sha }}`
            **Î∞∞Ìè¨ ÏãúÍ∞Ñ**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          color: 0x00ff00
          username: "TokTot Deploy Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"

      - name: Discord Î∞∞Ìè¨ Ïã§Ìå® ÏïåÎ¶º
        if: failure()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          title: "‚ùå TokTot ÏÑúÎ≤Ñ Î∞∞Ìè¨ Ïã§Ìå®"
          description: |
            **‚ö†Ô∏è Î∞∞Ìè¨ Ïã§Ìå® Í∞êÏßÄ**
            
            **üîç Ïã§Ìå®Ìïú Î∞∞Ìè¨**:
            - **Î∏åÎûúÏπò**: ${{ github.ref_name }}
            - **Ïª§Î∞ã**: ${{ github.event.head_commit.message }}
          color: 0xff0000
          username: "TokTot Deploy Bot"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"